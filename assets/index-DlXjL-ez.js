(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();class B{update;render;lastFrameTime;accumulatedTime;timeStep;rafId;isRunning;constructor(t,e){this.lastFrameTime=0,this.accumulatedTime=0,this.timeStep=1e3/60,this.update=t,this.render=e,this.rafId=null,this.isRunning=!1}mainLoop=t=>{if(!this.isRunning)return;let e=t-this.lastFrameTime;for(this.lastFrameTime=t,this.accumulatedTime+=e;this.accumulatedTime>=this.timeStep;)this.update(this.timeStep),this.accumulatedTime-=this.timeStep;this.render(),this.rafId=requestAnimationFrame(this.mainLoop)};start(){this.isRunning||(this.isRunning=!0,this.rafId=requestAnimationFrame(this.mainLoop))}stop(){this.rafId&&cancelAnimationFrame(this.rafId),this.isRunning=!1}}const C="LEFT",k="RIGHT",D="UP",I="DOWN",S={arrowUp:D,arrowDown:I,arrowLeft:C,arrowRight:k,KeyW:D,KeyS:I,KeyA:C,KeyD:k};class O{heldDirections;constructor(){this.heldDirections=[],document.addEventListener("keydown",t=>{t.code in S&&this.onArrowPressed(S[t.code])}),document.addEventListener("keyup",t=>{t.code in S&&this.onArrowReleased(S[t.code])})}get direction(){return this.heldDirections.at(0)}onArrowPressed(t){this.heldDirections.includes(t)||this.heldDirections.unshift(t)}onArrowReleased(t){const e=this.heldDirections.indexOf(t);e!==-1&&this.heldDirections.splice(e,1)}}class X{callbacks=[];nextId=0;emit(t,e){this.callbacks.forEach(s=>{s.eventName===t&&s.callback(e)})}on(t,e,s){return this.nextId+=1,this.callbacks.push({id:this.nextId,eventName:t,caller:e,callback:s}),this.nextId}off(t){this.callbacks=this.callbacks.filter(e=>e.id!==t)}unsubscribe(t){this.callbacks=this.callbacks.filter(e=>e.caller!==t)}}const l=new X,c=i=>i*16,Y=(i,t,e)=>!i.has(`${t},${e}`);class o{x;y;constructor(t=0,e=0){this.x=t,this.y=e}duplicate(){return new o(this.x,this.y)}}const _=i=>new o(Math.round(i.x),Math.round(i.y)),R=(i,t)=>i.x===t.x&&i.y===t.y,q=(i,t)=>`${i*16},${t*16}`,F=i=>i.reduce((t,e)=>(t.add(q(e.x,e.y)),t),new Set);class f{position;children;parent;hasReadyBeenCalled;input;isSolid;drawLayer;level;constructor({position:t,input:e}){this.position=t??new o(0,0),this.children=[],this.parent=null,this.hasReadyBeenCalled=!1,this.input=e,this.isSolid=!1,this.drawLayer=null,this.level=null}stepEntry(t,e){this.children.forEach(s=>s.stepEntry(t,e)),this.hasReadyBeenCalled||(this.hasReadyBeenCalled=!0,this.ready()),this.step(t,e)}ready(){}step(t,e){}draw(t,e,s){const n=e+this.position.x,r=s+this.position.y;this.drawImage(t,n,r),this.getDrawChildrenOrdered().forEach(a=>a.draw(t,n,r))}getDrawChildrenOrdered(){return[...this.children].sort((t,e)=>e.drawLayer===0?1:t.position.y-e.position.y)}drawImage(t,e,s){}destroy(){this.children.forEach(t=>t.destroy()),this.parent?.removeChild(this)}addChild(t){t.parent=this,this.children.push(t)}removeChild(t){l.unsubscribe(t),this.children=this.children.filter(e=>e!==t)}}const $=["sky","ground","hero","shadow","rod","exit","cave","caveGround","knight","textBox","spriteFont"];class j{toLoad;images;constructor(){this.toLoad={hero:"sprites/hero-sheet.png",shadow:"sprites/shadow.png",rod:"sprites/rod.png",exit:"sprites/exit.png",sky:"sprites/sky.png",ground:"sprites/ground.png",cave:"sprites/cave.png",caveGround:"sprites/cave-ground.png",knight:"sprites/knight-sheet-1.png",textBox:"sprites/text-box.png",spriteFont:"sprites/sprite-font-white.png"},this.images={},$.forEach(t=>{const e=new Image;e.src=this.toLoad[t],this.images[t]={image:e,isLoaded:!1},e.onload=()=>{this.images[t].isLoaded=!0}})}}const d=new j;class m extends f{resource;frameSize;hFrames;vFrames;frame;scale;position;animations;frameMap;constructor({resource:t,frameSize:e,hFrames:s,vFrames:n,frame:r,scale:a,position:u,animations:w}){super({}),this.resource=t,this.frameSize=e??new o(16,16),this.hFrames=s??1,this.vFrames=n??1,this.frame=r??0,this.frameMap=new Map,this.scale=a??1,this.position=u??new o(0,0),this.animations=w??null,this.buildFrameMap()}buildFrameMap(){let t=0;for(let e=0;e<this.vFrames;e++)for(let s=0;s<this.hFrames;s++)this.frameMap.set(t,new o(s*this.frameSize.x,e*this.frameSize.y)),t++}step(t){this.animations&&(this.animations.step(t),this.frame=this.animations.frame)}drawImage(t,e,s){if(!this.resource.isLoaded)return;const n=this.frameMap.get(this.frame),r=n?.x||0,a=n?.y||0;t.drawImage(this.resource.image,r,a,this.frameSize.x,this.frameSize.y,e,s,this.frameSize.x*this.scale,this.frameSize.y*this.scale)}}class b extends f{constructor(t,e){super({position:new o(t,e)}),this.addChild(new m({resource:d.images.exit})),this.drawLayer=0}ready(){l.on("HERO_POSITION",this,t=>{const e=_(t);R(this.position,e)&&l.emit("HERO_EXIT")})}}class V{patterns;activeKey;constructor(t){this.patterns=t,this.activeKey=Object.keys(this.patterns).at(0)}get frame(){if(this.activeKey)return this.patterns[this.activeKey].frame}play(t,e=0){this.activeKey!==t&&(this.activeKey=t,this.patterns[this.activeKey].currentTime=e)}step(t){this.activeKey&&this.patterns[this.activeKey].step(t)}}class y{currentTime;animationConfig;duration;constructor(t){this.currentTime=0,this.animationConfig=t,this.duration=t.duration??500}get frame(){const{frames:t}=this.animationConfig;for(let e=t.length-1;e>=0;e--)if(this.currentTime>=t[e].time)return t[e].frame;throw"Time is before the first keyframe"}step(t){this.currentTime+=t,this.currentTime>=this.duration&&(this.currentTime=0)}}const J=(i,t,e)=>{let s=t.x-i.position.x,n=t.y-i.position.y,r=Math.sqrt(s**2+n**2);if(r<=e)i.position.x=t.x,i.position.y=t.y;else{let a=s/r,u=n/r;i.position.x+=a*e,i.position.y+=u*e,s=t.x-i.position.x,n=t.y-i.position.y,r=Math.sqrt(s**2+n**2)}return r},E=i=>({duration:400,frames:[{time:0,frame:i+1},{time:100,frame:i},{time:200,frame:i+1},{time:300,frame:i+2}]}),T=i=>({duration:400,frames:[{time:0,frame:i}]}),Q=E(0),Z=E(3),tt=E(6),et=E(9),it=T(1),st=T(4),nt=T(7),rt=T(10),ot={duration:400,frames:[{time:0,frame:12}]};class H extends f{facingDirection;destinationPos;body;lastX;lastY;itemPickupTime;itemPickupShell;constructor(t,e){super({position:new o(t,e)});const s=new m({resource:d.images.shadow,frameSize:new o(32,32),position:new o(-8,-19)});this.addChild(s),this.body=new m({resource:d.images.hero,frameSize:new o(32,32),hFrames:3,vFrames:8,frame:2,position:new o(-8,-20),animations:new V({walkUp:new y(tt),walkRight:new y(Z),walkDown:new y(Q),walkLeft:new y(et),standUp:new y(nt),standRight:new y(st),standDown:new y(it),standLeft:new y(rt),pickUpDown:new y(ot)})}),this.addChild(this.body),this.facingDirection=I,this.destinationPos=this.position.duplicate(),this.lastX=0,this.lastY=0,this.itemPickupTime=0,this.itemPickupShell=null,l.on("ROD_PICKED_UP_BY_HERO",this,n=>{this.onPickUpItem(n)})}step(t,e){if(this.itemPickupTime>0){this.workOnItemPickup(t);return}J(this,this.destinationPos,1)<=1&&this.tryMove(e),this.tryEmitPosition()}tryEmitPosition(){this.lastX===this.position.x&&this.lastY===this.position.y||(this.lastX=this.position.x,this.lastY=this.position.y,l.emit("HERO_POSITION",this.position))}tryMove(t){const s={UP:{move:{x:0,y:-16},anim:"walkUp"},DOWN:{move:{x:0,y:16},anim:"walkDown"},LEFT:{move:{x:-16,y:0},anim:"walkLeft"},RIGHT:{move:{x:16,y:0},anim:"walkRight"}},n=t.input?.direction;if(!n){this.facingDirection==="UP"&&this.body.animations.play("standUp"),this.facingDirection==="RIGHT"&&this.body.animations.play("standRight"),this.facingDirection==="DOWN"&&this.body.animations.play("standDown"),this.facingDirection==="LEFT"&&this.body.animations.play("standLeft");return}if(!["UP","DOWN","LEFT","RIGHT"].includes(n))return;let r=this.destinationPos.x,a=this.destinationPos.y;const{move:u,anim:w}=s[n];if(u&&w){r+=u.x,a+=u.y,this.body.animations.play(w),this.facingDirection=n??this.facingDirection;const v=t.level?.walls?Y(t.level.walls,r,a):!0,P=this.parent?.children.find(g=>g.isSolid&&g.position.x===r&&g.position.y===a);v&&!P&&(this.destinationPos.x=r,this.destinationPos.y=a)}}onPickUpItem(t){const{image:e,position:s}=t;this.destinationPos=s,this.itemPickupTime=500,this.itemPickupShell=new f({}),this.itemPickupShell=new m({resource:e,position:new o(0,-18)}),this.addChild(this.itemPickupShell)}workOnItemPickup(t){this.itemPickupTime-=t,this.body.animations.play("pickUpDown"),this.itemPickupTime<=0&&this.itemPickupShell?.destroy()}}class U extends f{background;walls;heroStartPos;constructor(){super({}),this.background=null,this.walls=new Set,this.heroStartPos=null}}class A extends f{constructor(t,e){super({position:new o(t,e)});const s=new m({resource:d.images.rod,position:new o(0,-5)});this.addChild(s)}ready(){l.on("HERO_POSITION",this,t=>{const e=_(t);R(this.position,e)&&this.onCollideWithHero()})}onCollideWithHero(){this.destroy(),l.emit("ROD_PICKED_UP_BY_HERO",{image:d.images.rod,position:this.position})}}class at extends f{constructor(t,e){super({position:new o(t,e)}),this.isSolid=!0;const s=new m({resource:d.images.shadow,frameSize:new o(32,32),position:new o(-8,-19)});this.addChild(s);const n=new m({resource:d.images.knight,frameSize:new o(32,32),hFrames:2,vFrames:1,position:new o(-8,-20)});this.addChild(n)}}const ht=new o(c(6),c(5));class ct extends U{constructor(t={}){super(),this.background=new m({resource:d.images.cave,frameSize:new o(320,180)});const e=new m({resource:d.images.caveGround,frameSize:new o(320,180)});this.addChild(e);const s=new b(c(4),c(5));this.addChild(s),this.heroStartPos=t.heroStartPos||ht;const n=new H(this.heroStartPos.x,this.heroStartPos.y);this.addChild(n);const r=new A(c(10),c(6));this.addChild(r);const a=new at(c(8),c(4));this.addChild(a),this.walls=F([...dt,...lt,...mt])}ready(){l.on("HERO_EXIT",this,()=>{l.emit("CHANGE_LEVEL",new W({heroStartPos:new o(c(7),c(3))}))})}}const dt=[{x:3,y:1},{x:4,y:1},{x:5,y:3},{x:6,y:3},{x:6,y:4},{x:7,y:4},{x:8,y:3},{x:12,y:5},{x:13,y:5},{x:14,y:6}],lt=[{x:6,y:6},{x:7,y:6},{x:8,y:6},{x:11,y:6},{x:12,y:6},{x:13,y:6},{x:15,y:2},{x:16,y:2}],mt=[{x:2,y:4},{x:3,y:4},{x:3,y:5},{x:9,y:1},{x:12,y:2},{x:13,y:2},{x:13,y:3},{x:16,y:5}],ut=new o(c(6),c(5));class W extends U{constructor(t={}){console.log("Creating OutdoorLvl1",t),super(),this.background=new m({resource:d.images.sky,frameSize:new o(320,180)});const e=new m({resource:d.images.ground,frameSize:new o(320,180)});this.addChild(e);const s=new b(c(6),c(3));this.addChild(s),this.heroStartPos=t.heroStartPos||ut;const n=new H(this.heroStartPos.x,this.heroStartPos.y);this.addChild(n);const r=new A(c(10),c(6));this.addChild(r),this.walls=F([...pt,...ft,...wt,...yt])}ready(){l.on("HERO_EXIT",this,()=>{l.emit("CHANGE_LEVEL",new ct({heroStartPos:new o(c(5),c(5))}))})}}const pt=[{x:4,y:3},{x:14,y:2},{x:13,y:4}],ft=[{x:4,y:4},{x:4,y:5},{x:5,y:4},{x:5,y:5},{x:8,y:3},{x:9,y:3}],wt=[{x:7,y:5},{x:8,y:5},{x:9,y:5},{x:10,y:5}],yt=[{x:12,y:6},{x:13,y:6},{x:14,y:6}];class xt extends f{constructor(){super({}),l.on("HERO_POSITION",this,t=>{this.centerPositionOnTarget(t)}),l.on("CHANGE_LEVEL",this,t=>{console.log("::",t.heroStartPos),t.heroStartPos&&this.centerPositionOnTarget(t.heroStartPos)})}centerPositionOnTarget(t){this.position=new o(-t.x+152,-t.y+82)}}class gt extends f{items;nextId=0;constructor(){super({position:new o(5,5)}),this.drawLayer="HUD",this.items=[{id:-1,image:d.images.rod},{id:-2,image:d.images.rod}],l.on("ROD_PICKED_UP_BY_HERO",this,()=>{this.items.push({id:this.nextId++,image:d.images.rod}),this.renderInventory()}),this.renderInventory()}renderInventory(){this.children.forEach(t=>t.destroy()),this.items.forEach((t,e)=>{const s=new m({resource:t.image,position:new o(e*16,0)});this.addChild(s)})}removeFromInventory(t){this.items=this.items.filter(e=>e.id!==t),this.renderInventory()}}const vt=5,h=new Map;h.set("c",4);h.set("f",4);h.set("i",2);h.set("j",4);h.set("l",3);h.set("n",4);h.set("r",4);h.set("t",4);h.set("u",4);h.set("v",4);h.set("x",4);h.set("y",4);h.set("z",4);h.set("E",4);h.set("F",4);h.set("M",7);h.set("W",7);h.set(" ",3);h.set("'",1);h.set("!",1);const Pt=i=>h.get(i)||vt,N=new Map,St=["abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ","0123456789 __",".!-,?'"].join("").split("");St.forEach((i,t)=>{N.set(i,t)});const Et=i=>N.get(i)||0;class Tt extends f{backdrop;words;showingIndex;textSpeed;timeUntilnextChar;constructor(t){super({position:new o(32,112)}),this.drawLayer="HUD";const e=t??"Default text";this.words=e.split(" ").map(s=>{let n=0;const r=s.split("").map(a=>{const u=Pt(a);return n+=u,{width:u,sprite:new m({resource:d.images.spriteFont,hFrames:13,vFrames:6,frame:Et(a)})}});return{wordWidth:n,chars:r}}),this.backdrop=new m({resource:d.images.textBox,frameSize:new o(256,64)}),this.showingIndex=0,this.textSpeed=50,this.timeUntilnextChar=this.textSpeed}step(t){this.timeUntilnextChar-=t,this.timeUntilnextChar<=0&&(this.showingIndex++,this.timeUntilnextChar=this.textSpeed)}drawImage(t,e,s){this.backdrop.draw(t,e,s);const n=7,r=7,a=240,u=12;let w=e+n,v=s+r,P=0;this.words.forEach(g=>{e+a-w<g.wordWidth&&(v+=u,w=e+n),g.chars.forEach(z=>{if(P>=this.showingIndex)return;const{sprite:K,width:M}=z,G=w-5;K.draw(t,G,v),w+=M+1,P++}),w+=3})}}class It extends f{level;input;camera;constructor(){super({}),this.level=null,this.input=new O,this.camera=new xt}ready(){const t=new gt;this.addChild(t);const e=new Tt("Hello! This is a very long text that should probably wrap around to multiple lines.");this.addChild(e),l.on("CHANGE_LEVEL",this,s=>{this.setLevel(s)})}setLevel(t){this.level&&this.level.destroy(),this.level=t,this.addChild(this.level)}drawBackground(t){this.level?.background?.drawImage(t,0,0)}drawObjects(t){this.children.forEach(e=>{e.drawLayer!=="HUD"&&e.draw(t,0,0)})}drawForeground(t){this.children.forEach(e=>{e.drawLayer==="HUD"&&e.draw(t,0,0)})}}const L=document.getElementById("game"),x=L.getContext("2d"),p=new It;p.setLevel(new W);p.input=new O;const Lt=i=>{p.stepEntry(i,p)},Ct=()=>{x.clearRect(0,0,L.width,L.height),p.drawBackground(x),x.save(),p.camera&&x.translate(p.camera.position.x,p.camera.position.y),p.drawObjects(x),p.level,x.restore(),p.drawForeground(x)},kt=new B(Lt,Ct);kt.start();
